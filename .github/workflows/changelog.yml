name: Auto Changelog

on:
  push:
    branches:
      - main
      - master

jobs:
  update-changelog:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Send commits to changelog API
        env:
          BACKEND_URL: https://tippen-backend.benjiemalinao879557.workers.dev
          COMMITS_JSON: ${{ toJson(github.event.commits) }}
          GITHUB_REF: ${{ github.ref }}
          GITHUB_ACTOR: ${{ github.actor }}
          REPO_NAME: ${{ github.event.repository.name }}
          REPO_FULL_NAME: ${{ github.repository }}
        run: |
          # Skip if no commits (e.g., force push)
          if [ "$COMMITS_JSON" = "null" ] || [ -z "$COMMITS_JSON" ]; then
            echo "No commits to process"
            exit 0
          fi
          
          # Write commits to temp file to avoid shell escaping issues
          echo "$COMMITS_JSON" > /tmp/commits.json
          
          # Build payload using jq for proper JSON handling
          PAYLOAD=$(jq -n \
            --arg ref "$GITHUB_REF" \
            --arg actor "$GITHUB_ACTOR" \
            --arg repo_name "$REPO_NAME" \
            --arg repo_full "$REPO_FULL_NAME" \
            --slurpfile commits /tmp/commits.json \
            '{
              ref: $ref,
              pusher: { name: $actor, email: "" },
              commits: $commits[0],
              repository: { name: $repo_name, full_name: $repo_full }
            }')
          
          echo "Sending changelog update..."
          echo "Payload: $PAYLOAD"
          
          # Send to backend
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            -H "Content-Type: application/json" \
            -H "X-GitHub-Event: push" \
            -d "$PAYLOAD" \
            "${BACKEND_URL}/api/changelog/github-webhook")
          
          # Parse response
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "Response: $BODY"
          echo "HTTP Code: $HTTP_CODE"
          
          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "✅ Changelog updated successfully"
          else
            echo "⚠️ Changelog update failed (non-critical)"
            # Don't fail the workflow for changelog issues
            exit 0
          fi
